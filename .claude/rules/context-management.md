# Context Management Guidelines

## Overview

コンテキストウィンドウを効率的に使用し、セッション品質を維持するためのガイドライン。

**重要**: これはガイドラインであり、強制ルールではない。品質が最優先。必要であれば超えて良い。

---

## MCP Server Management

### 推奨設定

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| 登録MCPサーバー | 20-30個 | 選択肢を確保 |
| 有効化MCP | **10個以下** | コンテキスト縮小防止 |
| アクティブツール | **80個以下** | 200k→70k縮小を防ぐ |

### プロジェクト別無効化

必要なMCPのみ有効化し、不要なものは無効化する:

```json
// .claude/settings.json (プロジェクト別)
{
  "disabledMcpServers": [
    "server-name-1",
    "server-name-2"
  ]
}
```

---

## Tool Usage Efficiency

### 効率的なパターン

```
1. まずGlobで対象を絞る
   → 全ファイル読み込みを避ける

2. Grepでパターン検索
   → 関連箇所を特定してからRead

3. 必要なファイルのみRead
   → 行数指定で部分読み込み可能
```

### タスク別の目安（強制ではない）

| タスク | Glob | Read | Grep |
|--------|------|------|------|
| コードレビュー | 少 | 多 | 少 |
| バグ調査 | 少 | 中 | 多 |
| リファクタリング | 中 | 多 | 少 |
| 検索タスク | 多 | 少 | 多 |

**品質が最優先。必要であれば上記を超えて良い。**

---

## Context Low Prevention

### 警告サイン

- `/compact` の提案が出る
- レスポンスが途切れる
- 同じ内容を繰り返す

### 対処法

1. **即座に `/compact` を実行**
2. 新しいセッションを開始
3. 大きなファイルは行番号指定で部分読み

### 予防策（推奨）

```bash
# 大きなログを全部読まない
grep -i error run.log | tail -10   # ❌ Bash使用
# → Grep ツールで必要な行だけ取得  # ✅

# 出力を抑制
npm install > /dev/null 2>&1       # 出力不要なら抑制

# バックグラウンド実行
npm run build &                    # 完了を待たない
```

---

## Large File Handling

### 推奨アプローチ

| ファイルサイズ | アプローチ |
|---------------|-----------|
| < 500行 | 全体読み込みOK |
| 500-1000行 | 必要な部分のみ |
| > 1000行 | 行番号指定で分割読み |

### 行番号指定の例

```
Read tool with offset/limit:
- offset: 100 (100行目から開始)
- limit: 200 (200行だけ読む)
```

---

## Session Continuation

### セッション再開時

1. `SESSION_HANDOFF.md` があれば読む
2. `.workflow_state.json` の状態を確認
3. 前セッションのコンテキストを引き継ぐ

### セッション終了前

1. 重要な発見は memory_add で保存
2. 未完了タスクを SESSION_HANDOFF.md に記録
3. 次セッションへの引き継ぎを明確化

---

## Best Practices

### DO (推奨)

- 必要なファイルだけ読む
- Grepで事前フィルタリング
- 大きな出力は memory_add で保存
- 定期的な /compact 実行

### DON'T (非推奨)

- node_modules を読み込む
- ログファイル全体を読む
- 不要なMCPを有効化したまま
- コンテキスト警告を無視

---

## Quality First Principle

**コンテキスト効率より品質が優先。**

必要であれば:
- 多くのファイルを読んで良い
- 詳細な分析をして良い
- 時間をかけて良い

効率化は品質を犠牲にしない範囲で行う。
