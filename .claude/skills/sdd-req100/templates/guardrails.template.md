# AI Agent Guardrails: <spec-slug>

> AIエージェントの安全な動作を保証するためのガードレール定義。

## 1. 概要

| 項目 | 値 |
|------|-----|
| 対象プロジェクト | <プロジェクト名> |
| 定義日 | YYYY-MM-DD |
| バージョン | 1.0 |

## 2. Permission Boundaries（権限境界）

### 2.1 ファイルシステム

| パス | Read | Write | Delete | 理由 |
|------|------|-------|--------|------|
| `.kiro/specs/` | ✅ | ✅ | ❌ | 仕様ファイル管理 |
| `src/` | ✅ | ✅ | ✅ | ソースコード |
| `tests/` | ✅ | ✅ | ✅ | テストコード |
| `docs/` | ✅ | ✅ | ❌ | ドキュメント |
| `.env` | ❌ | ❌ | ❌ | 機密情報 |
| `.env.*` | ❌ | ❌ | ❌ | 機密情報 |
| `secrets/` | ❌ | ❌ | ❌ | 機密情報 |
| `node_modules/` | ❌ | ❌ | ❌ | 依存関係（不要） |
| `/` | ❌ | ❌ | ❌ | ルート（危険） |
| `~/.ssh/` | ❌ | ❌ | ❌ | SSH鍵 |
| `~/.aws/` | ❌ | ❌ | ❌ | AWS認証情報 |

### 2.2 コマンド実行

| カテゴリ | 許可 | ブロック | 備考 |
|---------|------|---------|------|
| **ビルド** | `npm run build`, `tsc` | - | 常時許可 |
| **テスト** | `npm test`, `jest` | - | 常時許可 |
| **Lint** | `npm run lint`, `eslint` | - | 常時許可 |
| **Git (Read)** | `git status`, `git log`, `git diff` | - | 常時許可 |
| **Git (Write)** | `git add`, `git commit` | `git push --force`, `git reset --hard` | 危険操作はブロック |
| **DB (Read)** | `SELECT` | - | Read-only許可 |
| **DB (Write)** | - | `DROP`, `TRUNCATE`, `DELETE *` | 要承認 |
| **ネットワーク** | `curl`, `wget` (localhost) | - | 外部は要確認 |
| **システム** | - | `rm -rf /`, `sudo`, `chmod 777` | 常時ブロック |

### 2.3 API/MCP呼び出し

| MCP/API | 許可 | 制限 | 備考 |
|---------|------|------|------|
| **filesystem** | Read: 許可, Write: 許可 | 上記パス制限 | |
| **github** | Read: 許可 | Write: 要承認 | PR作成は承認後 |
| **postgres** | Read: 許可 | Write: ブロック | Read-only |
| **notion** | Read/Write: 許可 | - | |
| **slack** | 通知: 許可 | - | |

## 3. Resource Limits（リソース制限）

| リソース | 制限値 | 理由 |
|---------|--------|------|
| **最大実行時間** | 10分/タスク | 無限ループ防止 |
| **最大ファイルサイズ** | 10MB | メモリ保護 |
| **最大出力行数** | 1000行 | コンテキスト保護 |
| **最大API呼び出し** | 100回/タスク | レート制限 |
| **最大同時実行** | 5並列 | リソース保護 |

## 4. Human-in-the-Loop Gates（承認ゲート）

### 4.1 必須承認（常に人間の承認が必要）

| アクション | 理由 | 承認者 |
|-----------|------|--------|
| 本番デプロイ | 不可逆、影響大 | Tech Lead |
| DB書き込み（本番） | データ整合性 | DBA |
| 外部API認証情報アクセス | セキュリティ | Security |
| 機密ファイル読み取り | コンプライアンス | Security |
| 大規模リファクタリング | 品質リスク | Tech Lead |
| 依存関係メジャーアップデート | 互換性リスク | Tech Lead |

### 4.2 条件付き承認（特定条件で承認が必要）

| アクション | 条件 | 承認者 |
|-----------|------|--------|
| ファイル削除 | 5ファイル以上 | 開発者 |
| テストスキップ | `--no-verify` 使用時 | 開発者 |
| 外部API呼び出し | 新規エンドポイント | 開発者 |

### 4.3 自動許可（承認不要）

| アクション | 条件 |
|-----------|------|
| ソースコード編集 | `src/`, `tests/` 内 |
| ドキュメント編集 | `docs/`, `.kiro/` 内 |
| ビルド・テスト実行 | 常時 |
| Git status/log/diff | 常時 |
| Lintエラー修正 | 常時 |

## 5. Audit Trail Requirements（監査証跡）

### 5.1 ログ必須項目

| イベント | 記録内容 | 保持期間 |
|---------|---------|---------|
| Tool呼び出し | ツール名、パラメータ、結果 | 30日 |
| ファイル変更 | パス、変更前後のハッシュ | 90日 |
| 承認/却下 | アクション、判定、理由 | 1年 |
| エラー | エラー内容、スタックトレース | 30日 |
| セッション | 開始/終了時刻、タスク一覧 | 90日 |

### 5.2 ログフォーマット

```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "session_id": "sess_xxx",
  "event_type": "tool_call",
  "tool": "Edit",
  "parameters": {
    "file_path": "/src/index.ts",
    "operation": "replace"
  },
  "result": "success",
  "duration_ms": 150,
  "user": "agent",
  "approval": {
    "required": false
  }
}
```

### 5.3 セッションサマリー

各セッション終了時に自動生成:

```markdown
## Session Summary

- **Duration**: 45 minutes
- **Tasks Completed**: 5
- **Files Modified**: 12
- **Tests Run**: 48 (passed)
- **Approvals Requested**: 2 (approved)
- **Errors**: 0

### Changes Made
1. src/auth/login.ts - Added MFA support
2. tests/auth/login.test.ts - Added test cases
...
```

## 6. Error Handling（エラー処理）

### 6.1 エラー時の動作

| エラー種別 | 動作 | 通知 |
|-----------|------|------|
| 権限エラー | 即時停止、ユーザーに報告 | 必須 |
| リソース制限超過 | 即時停止、サマリー出力 | 必須 |
| 外部API障害 | リトライ(3回)、失敗時停止 | 任意 |
| ファイル不在 | スキップ、続行 | 任意 |
| 構文エラー（生成コード） | 修正試行(3回)、失敗時停止 | 必須 |

### 6.2 ロールバック

| 条件 | アクション |
|------|-----------|
| テスト失敗 | 変更をgit stashで退避 |
| ビルドエラー | 直前のコミットに戻す提案 |
| 承認却下 | 該当変更を破棄 |

## 7. Workflow Rules（ワークフロールール）

### 7.1 フェーズ制約

| フェーズ | 許可スキル | ブロックスキル |
|---------|-----------|---------------|
| 要件定義 | sdd-req100, research | 実装系スキル |
| 設計 | sdd-design, sdd-threat | 実装系スキル |
| 実装 | 全て | - |
| テスト | test系 | デプロイ系 |
| デプロイ | deploy系 | 開発系（ロールバック除く） |

### 7.2 品質ゲート

| ゲート | 条件 | 次フェーズ移行 |
|--------|------|---------------|
| 要件承認 | C.U.T.E. >= 98 | 設計フェーズへ |
| 設計レビュー | レビュー承認 | 実装フェーズへ |
| テスト完了 | カバレッジ >= 80%, 全パス | デプロイフェーズへ |
| セキュリティ | 脅威モデルレビュー完了 | 本番デプロイへ |

## 8. 関連ドキュメント

- [CLAUDE.md](../../CLAUDE.md) - グローバルルール
- [requirements.md](./requirements.md) - 要件定義
- [threat-model.md](./threat-model.md) - 脅威モデル
