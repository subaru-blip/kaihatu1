# Threat Model: <spec-slug>

> STRIDE脅威モデリング。設計段階でセキュリティリスクを特定し、緩和策を要件化する。

## 1. 概要

| 項目 | 値 |
|------|-----|
| 対象システム | <システム名> |
| 分析日 | YYYY-MM-DD |
| 分析者 | - |
| レビュー者 | - |

## 2. 保護対象資産（Assets）

| ID | 資産 | 分類 | 重要度 | 説明 |
|----|------|------|--------|------|
| A-001 | ユーザー認証情報 | Confidential | Critical | パスワード、トークン |
| A-002 | 個人情報（PII） | Restricted | High | 名前、メール、住所 |
| A-003 | ビジネスデータ | Internal | Medium | 取引データ、レポート |
| A-004 | システム設定 | Internal | Medium | API Key、接続情報 |
| A-005 | 監査ログ | Internal | High | 操作履歴 |

### データ分類基準

| 分類 | 定義 | 例 |
|------|------|-----|
| **Confidential** | 漏洩時に重大な損害 | パスワード、秘密鍵 |
| **Restricted** | 法的保護対象 | PII、医療情報 |
| **Internal** | 社内限定 | 設計書、設定 |
| **Public** | 公開可能 | 製品情報 |

## 3. 信頼境界（Trust Boundaries）

```
┌─────────────────────────────────────────────────────────────┐
│                        Internet                              │
│  ┌─────────────┐                                            │
│  │   User      │                                            │
│  └──────┬──────┘                                            │
│         │ HTTPS                                              │
│ ════════╪═══════════════════════════════════════════════════│ TB-1: Internet/DMZ
│         ▼                                                    │
│  ┌─────────────┐     ┌─────────────┐                        │
│  │   CDN/WAF   │────▶│   Load      │                        │
│  │             │     │   Balancer  │                        │
│  └─────────────┘     └──────┬──────┘                        │
│                             │                                │
│ ════════════════════════════╪════════════════════════════════│ TB-2: DMZ/App
│                             ▼                                │
│  ┌───────────────────────────────────────────────────┐      │
│  │                  App Tier                          │      │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    │      │
│  │  │   Web    │───▶│   API    │───▶│  Worker  │    │      │
│  │  └──────────┘    └────┬─────┘    └──────────┘    │      │
│  └───────────────────────┼───────────────────────────┘      │
│                          │                                   │
│ ═════════════════════════╪═══════════════════════════════════│ TB-3: App/Data
│                          ▼                                   │
│  ┌───────────────────────────────────────────────────┐      │
│  │                  Data Tier                         │      │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    │      │
│  │  │    DB    │    │  Cache   │    │  Queue   │    │      │
│  │  └──────────┘    └──────────┘    └──────────┘    │      │
│  └───────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

| 境界ID | 境界 | 通過データ | 保護機構 |
|--------|------|-----------|---------|
| TB-1 | Internet/DMZ | ユーザーリクエスト | WAF, TLS 1.3 |
| TB-2 | DMZ/App | 内部リクエスト | mTLS, VPC |
| TB-3 | App/Data | DBクエリ | VPC, 暗号化 |

## 4. STRIDE脅威分析

### 4.1 Spoofing（なりすまし）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-S01 | 認証情報の盗取 | A-001 | フィッシング、中間者攻撃 | Critical | Medium | High | MFA、証明書ピン留め | REQ-SEC-001 |
| T-S02 | セッションハイジャック | A-001 | XSS、セッション固定 | High | Medium | High | HttpOnly, SameSite Cookie | REQ-SEC-002 |
| T-S03 | APIキー偽装 | A-004 | キー漏洩、総当たり | High | Low | Medium | レート制限、IP制限 | REQ-SEC-003 |

### 4.2 Tampering（改ざん）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-T01 | リクエスト改ざん | A-003 | パラメータ操作 | High | High | High | 入力検証、署名 | REQ-SEC-004 |
| T-T02 | DB改ざん | A-002, A-003 | SQLインジェクション | Critical | Medium | High | パラメータ化クエリ | REQ-SEC-005 |
| T-T03 | ログ改ざん | A-005 | ログインジェクション | Medium | Low | Low | ログ分離、署名 | REQ-SEC-006 |

### 4.3 Repudiation（否認）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-R01 | 操作否認 | A-005 | ログ不在・不完全 | Medium | Medium | Medium | 監査ログ、タイムスタンプ | REQ-SEC-007 |
| T-R02 | トランザクション否認 | A-003 | 証跡不備 | High | Low | Medium | 署名付きレシート | REQ-SEC-008 |

### 4.4 Information Disclosure（情報漏洩）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-I01 | PII漏洩 | A-002 | 不正アクセス、バックアップ漏洩 | Critical | Medium | Critical | 暗号化、アクセス制御 | REQ-SEC-009 |
| T-I02 | エラーメッセージ漏洩 | A-004 | スタックトレース表示 | Low | High | Medium | エラーマスキング | REQ-SEC-010 |
| T-I03 | ログ経由漏洩 | A-001, A-002 | 機密情報のログ出力 | High | Medium | High | ログマスキング | REQ-SEC-011 |

### 4.5 Denial of Service（サービス拒否）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-D01 | DDoS | システム全体 | 大量リクエスト | High | High | High | WAF、CDN、レート制限 | REQ-SEC-012 |
| T-D02 | リソース枯渇 | システム全体 | 大量ファイルアップロード | Medium | Medium | Medium | サイズ制限、クォータ | REQ-SEC-013 |
| T-D03 | Slowloris | システム全体 | 接続保持攻撃 | Medium | Low | Low | タイムアウト設定 | REQ-SEC-014 |

### 4.6 Elevation of Privilege（権限昇格）

| ID | 脅威 | 対象 | 攻撃シナリオ | 影響 | 可能性 | リスク | 緩和策 | 対応要件 |
|----|------|------|-------------|------|--------|--------|--------|---------|
| T-E01 | 水平権限昇格 | A-002, A-003 | IDOR（直接オブジェクト参照） | High | High | High | 認可チェック | REQ-SEC-015 |
| T-E02 | 垂直権限昇格 | 全資産 | ロールバイパス | Critical | Medium | Critical | RBAC、最小権限 | REQ-SEC-016 |
| T-E03 | 特権コンテナ | A-004 | コンテナエスケープ | Critical | Low | High | 非特権コンテナ | REQ-SEC-017 |

## 5. リスクマトリックス

```
        │ Low        Medium      High        Critical
────────┼───────────────────────────────────────────────
High    │ Medium     High        Critical    Critical
        │ T-I02      T-T01       T-D01
Medium  │ Low        Medium      High        Critical
        │ T-R01      T-E01       T-S01,T-I01 T-E02
Low     │ Low        Low         Medium      High
        │ T-T03      T-D03       T-S03       T-E03
────────┼───────────────────────────────────────────────
 可能性 │                     影響度
```

## 6. 緩和策サマリー

| 優先度 | 緩和策 | 対応脅威 | 実装コスト | 対応要件 |
|--------|--------|---------|-----------|---------|
| P1 | 入力検証・パラメータ化クエリ | T-T01, T-T02 | Low | REQ-SEC-004,005 |
| P1 | 認可チェック（IDOR防止） | T-E01 | Low | REQ-SEC-015 |
| P1 | RBAC・最小権限原則 | T-E02 | Medium | REQ-SEC-016 |
| P1 | データ暗号化（At Rest/In Transit） | T-I01 | Medium | REQ-SEC-009 |
| P2 | MFA導入 | T-S01 | Medium | REQ-SEC-001 |
| P2 | WAF・レート制限 | T-D01, T-S03 | Medium | REQ-SEC-012 |
| P2 | 監査ログ | T-R01, T-R02 | Low | REQ-SEC-007,008 |
| P3 | ログマスキング | T-I03 | Low | REQ-SEC-011 |

## 7. セキュリティ要件（追加）

以下の要件をrequirements.mdに追加:

```markdown
### REQ-SEC-001: 多要素認証
- 種別: EARS-オプション
- 優先度: SHOULD
- 要件文(EARS): MFAが有効な場合、システムは認証時に第二要素を要求しなければならない。
- 受入テスト(GWT): Given MFA有効ユーザー When ログイン試行 Then TOTP入力を要求

### REQ-SEC-015: IDOR防止
- 種別: EARS-普遍
- 優先度: MUST
- 要件文(EARS): システムはリソースアクセス時に所有者を検証しなければならない。
- 受入テスト(GWT): Given ユーザーA所有リソース When ユーザーBがアクセス Then 403を返す
```

## 8. 関連ドキュメント

- [requirements.md](./requirements.md) - 要件定義（セキュリティ要件追加先）
- [design.md](./design.md) - セキュリティ設計セクション
- [slo.md](./slo.md) - セキュリティ関連SLI/SLO
- [runbook.md](./runbook.md) - セキュリティインシデント対応
